{% import "Ceres::Widgets.Helper.TwigBuilder" as Twig %}
{% import "Ceres::Widgets.Helper.WidgetHelper" as WidgetHelper %}

{% set uid = uid() %}

{% set customClass = widget.settings.customClass.mobile %}
{% set spacingSettings = widget.settings.spacing %}
{% set inlineSpacings = WidgetHelper.getInlineSpacings(spacingSettings, spacingSettings.customPadding.mobile, spacingSettings.customMargin.mobile) %}
{% set spacingClasses = WidgetHelper.getSpacingClasses(spacingSettings, spacingSettings.customPadding.mobile, spacingSettings.customMargin.mobile) %}

{% set isFixed              = widget.settings.isFixed.mobile %}
{% set navigationStyle      = widget.settings.navigationStyle.mobile %}
{% set companyLogoUrl       = widget.settings.companyLogoUrl.mobile %}
{% set fallbackImagePath    = widget.settings.fallbackImagePath.mobile %}

{% set megaMenuMaxItems1    = widget.settings.megaMenuMaxItems.stage1.mobile | default(30) %}
{% set megaMenuMaxItems2    = widget.settings.megaMenuMaxItems.stage2.mobile | default(3) %}
{% set megaMenuMaxItems3    = widget.settings.megaMenuMaxItems.stage3.mobile | default(2) %}
{% set megaMenuMaxItems     = { "1": megaMenuMaxItems1, "2": megaMenuMaxItems2, "3": megaMenuMaxItems3 } %}

{% if navigationStyle == 'megaMenu' %}
    {% set megaMenuLevels       = widget.settings.megaMenuLevels.mobile | default(2) %}
{% else %}
    {% set megaMenuLevels = 2 %}
{% endif %}

{% if companyLogoUrl is empty %}
    {% set companyLogoUrl = ceresConfig.header.companyLogo %}
    {% if not (companyLogoUrl starts with 'https://' or companyLogoUrl starts with 'http://' or companyLogoUrl starts with 'layout/') and companyLogoUrl | trim | length > 0 %}
        {% set companyLogoUrl = plugin_path('Ceres') ~ "/" ~ companyLogoUrl %}
    {% endif %}
{% endif %}

{% if fallbackImagePath | trim is empty %}
    {% set fallbackImagePath = companyLogoUrl %}
{% endif %}

{{ Twig.set("logoUrl", companyLogoUrl | json_encode) }}
{{ Twig.print("add_asset(logoUrl,'image')") }}

{{ Twig.import("Tree", "Ceres::Category.Macros.CategoryTree") }}
{{ Twig.set("overrideSearchBar", Twig.call("LayoutContainer.show", ["Ceres::Search.SearchBar"])) }}

<nav class="navbar header-fw p-0 border-bottom{% if customClass | length > 0 %} {{ customClass }}{% endif %}{% if navigationStyle == 'megaMenu' %} megamenu{% else %} normalmenu{%endif%}{% if not isFixed %} unfixed{% endif %}">
    <div class="container-max px-0 d-block{% if spacingClasses | length > 0 %} {{ spacingClasses }}{% endif %}"
    {% if inlineSpacings | length > 0 %} style="{{ inlineSpacings }}"{% endif %}>
        <div class="row mx-0 position-relative d-flex align-items-center">
            <div class="col-8 col-sm-6 col-md-3">
                {% if companyLogoUrl | trim | length > 0 %}
                <a class="navbar-brand" href="{{ Twig.print('urls.home') }}">
                    <picture>
                        <source srcset="{{ companyLogoUrl }}"{% if companyLogoUrl matches '/.?(\\.webp)(?:$|\\?)/' %} type="image/webp"{% endif %}>
                        <img
                            class="img-fluid"
                            src="{{ fallbackImagePath }}"
                            alt="{{ Twig.print('trans("Ceres::Template.headerCompanyName")') }}"
                        />
                    </picture>
                </a>
                {% endif %}
            </div>

            <div class="col-md-6 searchCol d-none d-lg-block">
                {{ Twig.if("overrideSearchBar | trim is empty") }}
                    <div class="always-visible-search flex-grow-1">
                        {% if not isPreview %}<lazy-hydrate when-idle>{% endif %}
                            <item-search>
                                <div class="position-relative d-flex flex-grow-1">
                                    <input type="search" class="search-input px-3 py-2 flex-grow-1" aria-label="{{ Twig.print('trans("Ceres::Template.headerSearchTerm")') }}">
                                    <button class="search-submit px-3" type="submit" aria-label="{{ Twig.print('trans("Ceres::Template.headerSearch")') }}">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>

                                {% if isPreview %}
                                    <template #search-button>
                                        <button class="search-submit px-3" type="submit" {{ WidgetHelper.makeClickable(isPreview) }} data-toggle="collapse" href="#search-suggestions_{{ uid }}" role="button">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </template>
                                {% endif %}

                                {% if isPreview or children is defined and children.suggestions | trim is not empty %}
                                    <template #autocomplete-suggestions>
                                        <div class="autocomplete-suggestions shadow bg-white w-100{% if isPreview %} collapse position-relative mh-100{% endif %}"
                                            {% if isPreview %} data-builder-child-container="suggestions" id="search-suggestions_{{ uid }}"{% endif %}>
                                            {{ children.suggestions | raw }}
                                        </div>
                                    </template>
                                {% endif %}
                            </item-search>
                        {% if not isPreview %}</lazy-hydrate>{% endif %}
                    </div>
                {{ Twig.else() }}
                    {{ Twig.print("overrideSearchBar | raw") }}
                {{ Twig.endif() }}
            </div>
            <div class="col-md-3 dg-buttons d-none d-lg-block" @mouseover.once="$store.dispatch('loadComponent', 'basket-preview')">
                <a v-toggle-basket-preview href="#" class="warenkorb">
                    <img src="{{ plugin_path('Dekoundgarten') }}/images/basket.png">
                    <span class="text">Warenkorb</span>
                    <span class="badge" v-basket-item-quantity="$store.state.basket.data.itemQuantity">0</span>
                </a>
                <a href="{{ urls.wishList }}" class="merkzettel">
                    <img src="{{ plugin_path('Dekoundgarten') }}/images/merkzettel.png">
                    <span class="text">Merkzettel</span>
                </a>
            </div>
            <div class="col-4 col-sm-6 col-md-9 d-lg-none">
                <button v-open-mobile-navigation class="navbar-toggler d-lg-none p-3" type="button">
                    &#9776;
                </button>
             </div>
        </div>
    </div>
    <div id="mainTopMenuWrapper" class="d-none d-lg-block">
        <div class="container-max">
            <div class="main-navbar-collapsable">
                <ul class="mainmenu p-0 m-0 d-flex">
                    {{ Twig.print(Twig.call("Tree.get_nav_bar", [Twig.var("categories"), "", megaMenuLevels, megaMenuMaxItems])) }}
                </ul>
            </div>
        </div>
    </div>
</nav>

